---
title: "Deciduous Phenology on a Latitudinal Gradient"
author: "Bijan Seyednasrollah"
date: "06/30/2019"
output:
  html_document: default
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Deciduous Phenology on a Latitudinal Gradient

This is a quick tutorial to show how to make a time-lapse animation using PhenoCam images from six sites on latitudinal gradient. We select the following sites:

* [Russell Sage](https://phenocam.sr.unh.edu/webcam/sites/russellsage/).
* [Duke Forest](https://phenocam.sr.unh.edu/webcam/sites/dukehw/).
* [Mammoth Cave](https://phenocam.sr.unh.edu/webcam/sites/mammothcave/).
* [Harvard Forest](https://phenocam.sr.unh.edu/webcam/sites/harvard/).
* [Cary Institute](https://phenocam.sr.unh.edu/webcam/sites/caryinstitute/).
* [Laurentides](https://phenocam.sr.unh.edu/webcam/sites/laurentides/).


#### First load the required R packages
```{r req, eval=FALSE}
library(maps)
library(ggplot2)
library(phenocamapi)
library(data.table)
library(jpeg)
library(animation)
```

#### Obtain the timeseries
```{r ts, eval=FALSE}

#obtaining all the time-series directly from the PhenoCam server and binding them together
ts <- rbind(
  data.table(get_pheno_ts(site = 'russellsage', vegType = 'DB', roiID = 1000, type = '1day'), site = 'russellsage'),
  data.table(get_pheno_ts(site = 'dukehw', vegType = 'DB', roiID = 1000, type = '1day'), site = 'dukehw'),
  data.table(get_pheno_ts(site = 'mammothcave', vegType = 'DB', roiID = 4000, type = '1day'), site = 'mammothcave'),
  data.table(get_pheno_ts(site = 'harvard', vegType = 'DB', roiID = 1000, type = '1day'), site = 'harvard'),
  data.table(get_pheno_ts(site = 'caryinstitute', vegType = 'DB', roiID = 1000, type = '1day'), site = 'caryinstitute'),
  data.table(get_pheno_ts(site = 'laurentides', vegType = 'DB', roiID = 1000, type = '1day'), site = 'laurentides'))
```

#### Obtain the metadata and cleanup the data
```{r metadata, eval=FALSE}

phenos <- phenocamapi::get_phenos()

# creating two vectors of site names, one based on their PhenoCam names, and another from their descriptive names
sites <- c("russellsage", "dukehw", "mammothcave", "harvard", "caryinstitute", "laurentides")
Sites <- c("Russell Sage", "Duke Forest", "Mammoth Cave", "Harvard Forest", "Cary Institute", "Laurentides")

# assigning  color to each site
cols <- c('#808080', '#001Af7', '#94F016', '#a31f33', '#FF8118', '#11B6B6')

#getting the coordinates for all the sites listed
coords <- phenos[site%in%sites,.(site= factor(site, levels = sites), lon, lat)][order(site)]

# selecting the year for which the data will be plotted
dt <- ts[year==2016,.(site, date= as.Date(date), gcc_90, midday_filename)]

```


#### Normalize the obtained time-series for each site
This is important to be able to show them on the same axis.

```{r norm, eval=FALSE}

# a little hacky commands to normalize the gcc values for 
# all the sites based on their minimum values (before day 40) 
# and their maximum values between days 120 to 210
dt <- merge(dt, 
            dt[yday(date)<40, .(gmin=median(gcc_90, na.rm = T)), site]) #to get the miniumn

dt <- merge(dt, 
            dt[yday(date)%in%(120:210), .(gmax=median(gcc_90, na.rm = T)), site]) # to get the "maximum" gcc

for(s in unique(dt$site))  dt[site==s, gcc:=(gcc_90 - gmin)/(gmax - gmin)] # normalizing the timeseries for each site

# making a data.table of site, date, gcc, image URL, image local file ( to be downloaded)
dt <- dt[,.(site, date, gcc, 
            dest = paste0('data/', midday_filename), 
            url = sprintf('https://phenocam.sr.unh.edu/data/archive/%s/%d/%02d/%s', site, year(date), month(date), midday_filename))]

# removing rows without GCC values
dt <- dt[!is.na(gcc),]

# smoothing the GCC per site
dt[,gcc:=smooth(gcc),site]

# a test plot to see the time-series before making the animation
ggplot(dt, aes(date, gcc, color = site)) + geom_line()
```


#### Download all the selected midday images
```{r download, eval=FALSE}

dir.create('data', showWarnings = TRUE)

# identifying files that already exist on the disk
w <- !file.exists(dt$dest)

if(sum(w)>0)  # dowloading the files that don't exist on the disk
  tmp <- mapply(download.file, 
         url = dt$url[w], 
         destfile = dt$dest[w], 
         quiet = T, 
         method = 'curl')
```

#### Creating the single frame function
```{r single, eval=FALSE}


# the plotting function
single_frame  <- function(d){
  
  # setting up the layout
  layout(mat = matrix(c(1,1, 2,2, 3,3, 4,4, 5,5, 6,6, 7,7,7,7, 8,8), nrow = 3, ncol = 6, byrow = T))
  par(mar=c(0,0,0,0), bg = '#000000')
  
  for(i in 1:length(sites)){
    plot(0:1,0:1, type='n', axes= FALSE, xlab= '', ylab = '') # empty plot
    fl <- dt[site==sites[i]&date==d, dest]
    if(length(fl)==0) next() # skip if there is no image
    
    img <- readJPEG(fl) #loading the image
    
    rasterImage(img, 0, 0, 1, 1)# plotting the image
    
    mtext(text = Sites[i], col = '#51fddc', line = -5, side = 1, font = 2, adj = .1, cex = 3) #adding the caption
  }
  
  
  # plotting the time-series upto that date for the first site
  plot(dt[site==sites[1]&date<=d,date],
       dt[site==sites[1]&date<=d,gcc],
       axes = F,
       bty ='n',  type = 'l', lwd = 5, col = cols[1], col.axis = '#51fddc',
       xlim = range(dt$date), ylim = range(dt$gcc, na.rm = TRUE)
  )
  
  # plotting the time-series upto that date for other sites
  for(i in 2:length(sites))
    lines(dt[site==sites[i]&date<=d,date],
          dt[site==sites[i]&date<=d,gcc], 
          lwd = 5, col = cols[i])
  
  mtext('Canopy Greenness', side = 1, line = -2, col = '#51fddc', cex = 3, font = 2)
  
  # adding the legend
  legend('topleft', fill = cols, legend = Sites, col = cols, text.col = cols, cex = 4, text.font = 2)  
  
  
  # adding the map
  map('usa', xlim = c(-91, -72), col = '#51fddc')
  coords[site%in%sites,points(lon, lat, col = cols, pch = 19, cex = 6)]

  
}

# test to see if the function works for a single date
png(filename = 'tmp.png', width = 30, height = 20, bg = NA, units = 'in', res = 300)
single_frame(as.Date('2016-12-30'))
dev.off()
````

#### Making the video
```{r anim, eval=FALSE}

# exculding the dates that not all the sites have an image
complete_dates <- sort(dt[!grepl(dest, pattern = 'None'),length(unique(site)),date][V1==6, date])
n <- length(complete_dates)


# make the animation using the saveVideo animation file
saveVideo(interval = 0.3, # animation interval in seconds
          ani.width = 1500,# image width in pixels
          ani.height = 1000,# image height in pixels
          video.name = 'six-sites.mp4',
          for(i in 1:n){
            cat(as.character(complete_dates[i]), '\n')
            single_frame(complete_dates[i])
          })


```


The final video can be downloaded from [this link](six-sites-phenology.mp4).
